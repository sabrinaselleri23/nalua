// script.js (substituir por completo)

/* ===========================
   UTILIT√ÅRIOS E DEBUG
   =========================== */
function log(...args){ console.log("[NALUA]", ...args); }
function warn(...args){ console.warn("[NALUA]", ...args); }
function safeGet(id){ return document.getElementById(id) || null; }

/* ===========================
   CHATBOT ACOLHIMENTO
   =========================== */
try {
  const acolhimento = "Agradecemos que voc√™ tenha sido forte ‚Äî procurar ajuda √© um grande passo. Podemos te conectar com um atendimento via WhatsApp agora.";
  const welcomeEl = safeGet('welcomeText');
  if (welcomeEl) welcomeEl.textContent = acolhimento;
  else warn("Elemento #welcomeText n√£o encontrado.");

  const modal = safeGet('chatModal');
  const openBtns = [safeGet('openChatBtn'), safeGet('openChatBtn2')].filter(Boolean);
  openBtns.forEach(btn => btn.addEventListener('click', () => {
    if (modal) modal.classList.add('show');
    else warn("Modal (#chatModal) n√£o encontrado.");
  }));
  if (safeGet('closeModal')) safeGet('closeModal').onclick = () => modal?.classList.remove('show');
  if (safeGet('closeModal2')) safeGet('closeModal2').onclick = () => modal?.classList.remove('show');

  const PHONE_NUMBER = ""; // preencha se quiser n√∫mero fixo
  const MESSAGE = "Agrade√ßo pelo acolhimento. Preciso de ajuda.";

  function waUrl(phone, text) {
    const encoded = encodeURIComponent(text || "");
    return phone ? `https://api.whatsapp.com/send?phone=${phone}&text=${encoded}`
                 : `https://api.whatsapp.com/send?text=${encoded}`;
  }

  const waSendBtn = safeGet('waSendBtn');
  if (waSendBtn) waSendBtn.href = waUrl(PHONE_NUMBER, MESSAGE);
  const whatsappQuick = safeGet('whatsappQuick');
  if (whatsappQuick) whatsappQuick.addEventListener('click', e => {
    e.preventDefault();
    window.open(waUrl(PHONE_NUMBER, MESSAGE), "_blank");
  });
} catch (e) {
  console.error("[NALUA] Erro no bloco de chatbot:", e);
}

/* ===========================
   NOT√çCIAS AUTOM√ÅTICAS (simples)
   =========================== */
try {
  const newsList = safeGet('newsList');
  async function fetchNews() {
    try {
      const res = await fetch('https://api.quotable.io/random');
      if (!res.ok) throw new Error("Erro ao buscar not√≠cia (status " + res.status + ")");
      const j = await res.json();
      if (!newsList) return;
      const item = document.createElement('div');
      item.className = 'news-item';
      item.innerHTML = `<strong>${j.author}</strong><p>${j.content}</p>`;
      newsList.prepend(item);
      while (newsList.children.length > 6) newsList.removeChild(newsList.lastChild);
    } catch(err){
      console.error("[NALUA] fetchNews erro:", err);
    }
  }
  if (newsList) {
    fetchNews();
    setInterval(fetchNews, 12000);
    const loadBtn = safeGet('loadNews');
    if (loadBtn) loadBtn.onclick = fetchNews;
  } else {
    warn("Elemento #newsList n√£o encontrado ‚Äî pulando not√≠cias.");
  }
} catch(e){
  console.error("[NALUA] Erro no bloco de not√≠cias:", e);
}

/* ===========================
   MAPA ‚Äî LEAFLET (defensivo)
   =========================== */
let map = null;
let markersGroup = null;
let locais = [];

function initMapOnce() {
  try {
    if (map) return; // j√° inicializado

    if (typeof L === "undefined") {
      warn("Leaflet (L) n√£o est√° carregado. Verifique a importa√ß√£o do leaflet.js");
      return;
    }

    const mapEl = safeGet('map');
    if (!mapEl) { warn("#map n√£o encontrado"); return; }

    // Garantir que o container tenha altura (caso CSS ainda n√£o aplicado)
    const rect = mapEl.getBoundingClientRect();
    if (rect.height === 0) {
      // tenta aguardar o CSS aplicar
      setTimeout(initMapOnce, 150);
      log("Esperando #map ficar com altura...");
      return;
    }

    map = L.map('map', { zoomControl: true }).setView([-23.55, -46.63], 12);

    L.tileLayer(
      "https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png",
      { maxZoom: 18, attribution: "&copy; OpenStreetMap contributors" }
    ).addTo(map);

    markersGroup = L.layerGroup().addTo(map);

    // Pequeno timeout para garantir render correto em containers din√¢micos
    setTimeout(() => {
      try { map.invalidateSize(); log("map.invalidateSize() chamado"); } catch(e){ warn("invalidateSize falhou", e); }
    }, 250);

    // Ap√≥s inicializar, tenta localizar usu√°rio
    localizarUsuario(); 
  } catch (e) {
    console.error("[NALUA] initMapOnce erro:", e);
  }
}

// LOCALIZA√á√ÉO DO USU√ÅRIO
function localizarUsuario() {
  try {
    if (!navigator.geolocation) { warn("Geolocaliza√ß√£o n√£o dispon√≠vel"); return; }
    navigator.geolocation.getCurrentPosition(pos => {
      try {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        if (map) {
          map.setView([lat, lon], 14);
          L.circleMarker([lat, lon], { radius:8, color:"#7b4dbb", fillColor:"#a47be6", fillOpacity:1 }).addTo(map).bindPopup("üìç Voc√™ est√° aqui");
        }
        buscarApoio(lat, lon);
      } catch(e){ console.error("[NALUA] error localizando usu√°rio:", e); }
    }, (err) => {
      warn("N√£o foi poss√≠vel obter localiza√ß√£o do usu√°rio:", err);
      // inicializa mapa mesmo sem localiza√ß√£o do usu√°rio
    }, { timeout: 8000 });
  } catch (e) {
    console.error("[NALUA] localizarUsuario erro:", e);
  }
}

// BUSCAR LOCAIS (Overpass)
async function buscarApoio(lat = -23.55, lon = -46.63) {
  try {
    const query = `
      [out:json];
      (
        node["amenity"="clinic"](around:10000, ${lat}, ${lon});
        node["healthcare"="psychotherapist"](around:10000, ${lat}, ${lon});
        node["healthcare"="mental_health"](around:10000, ${lat}, ${lon});
        node["amenity"="social_facility"](around:10000, ${lat}, ${lon});
        node["social_facility"="mental_health"](around:10000, ${lat}, ${lon});
        node["social_facility"="support"](around:10000, ${lat}, ${lon});
        node["social_facility"="outreach"](around:10000, ${lat}, ${lon});
      ); out body; >; out skel qt;
    `;
    const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
    const res = await fetch(url);
    if (!res.ok) { warn("Overpass API retornou status", res.status); return; }
    const data = await res.json();
    if (!data.elements || !data.elements.length) { log("Nenhum servi√ßo pr√≥ximo encontrado pela Overpass."); return; }
    locais = data.elements.filter(el => el.tags);
    renderMarkers();
  } catch (e) {
    console.error("[NALUA] buscarApoio erro:", e);
  }
}

// RENDERIZAR MARCADORES
function renderMarkers() {
  try {
    if (!markersGroup) markersGroup = L.layerGroup().addTo(map);
    markersGroup.clearLayers();

    const activeButtons = Array.from(document.querySelectorAll(".filter-btn.active")).map(b => b.dataset.cat || b.dataset.category || b.dataset.cat);
    // compatibilidade com dataset diferente
    const activeCategories = activeButtons.length ? activeButtons : ["caps","clinicas","psicologos","gratuitos"];

    locais.forEach(el => {
      try {
        const tags = el.tags || {};
        const cat = tags.amenity || tags.healthcare || tags.social_facility || "gratuitos";
        let categoria = "gratuitos";
        const nameLower = (tags.name || "").toLowerCase();

        if (/clinic|clinica|clinicas/.test(cat) || /clinic|psychotherapist|mental_health/.test(cat)) categoria = "clinicas";
        if (/caps/.test(nameLower) || (tags["service"] && tags["service"].toLowerCase().includes("caps"))) categoria = "caps";
        if (/psychologist|psicolog|psi/.test(nameLower) || cat.includes("psychologist")) categoria = "psicologos";

        if (!activeCategories.includes(categoria)) return;

        const iconUrl = {
          caps: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png",
          clinicas: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
          psicologos: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
          gratuitos: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png"
        }[categoria] || "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png";

        const icon = L.icon({ iconUrl, iconSize: [25,41], iconAnchor: [12,41] });

        const popupHtml = `<b>${tags.name || "Local sem nome"}</b><br>
          <small>${tags.amenity || tags.healthcare || tags.social_facility || "Apoio Psicol√≥gico"}</small><br>
          ${tags["addr:street"] || ""} ${tags["addr:housenumber"] || ""}<br>
          ${tags["addr:city"] || ""}<br><br>
          <a href="https://www.google.com/maps/?q=${el.lat},${el.lon}" target="_blank" style="color:#a47be6; font-weight:700;">üìç Ver rota no Google Maps</a>`;

        L.marker([el.lat, el.lon], { icon }).addTo(markersGroup).bindPopup(popupHtml);
      } catch(inner){
        console.error("[NALUA] erro ao criar marcador para elemento", el, inner);
      }
    });

  } catch (e) {
    console.error("[NALUA] renderMarkers erro:", e);
  }
}

/* ===========================
   FILTROS UI
   =========================== */
try {
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      btn.classList.toggle("active");
      renderMarkers();
    });
  });

  document.querySelectorAll(".radius-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      // atualmente n√£o altera a query Overpass (apenas re-render)
      document.querySelectorAll(".radius-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderMarkers();
    });
  });
} catch(e){
  console.error("[NALUA] erro nos filtros:", e);
}

/* ===========================
   INICIALIZA√á√ÉO NO DOM READY
   =========================== */
document.addEventListener("DOMContentLoaded", () => {
  try {
    // Tenta inicializar o mapa (verifica√ß√µes internas)
    initMapOnce();

    // Caso o mapa ainda n√£o tenha altura, for√ßa um ajuste depois de carregado o CSS
    setTimeout(() => {
      if (map && typeof map.invalidateSize === "function") {
        try { map.invalidateSize(); log("invalidateSize() executado ap√≥s DOMContentLoaded"); } catch(e){/*ignore*/ }
      } else {
        log("Mapa n√£o inicializado ainda, chamando initMapOnce novamente.");
        initMapOnce();
      }
    }, 500);
  } catch(e){
    console.error("[NALUA] erro no DOMContentLoaded:", e);
  }
});
